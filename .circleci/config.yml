default_machine: &default_machine
  machine:
    # might not have any effect, since dlc is a premium feature
    docker_layer_caching: true

version: 2
jobs:
  build:
    <<: *default_machine
    steps:
      - checkout
      - run:
          name: npm install
          command: |
            cd frontend
            npm install
            cd -
      - run:
          name: greenkeeper lockfile update
          command: |
            cd frontend
            node ./node_modules/.bin/greenkeeper-lockfile-update
            cd -
      - run:
          name: test images
          command: |
            ./build.sh test
      - run:
          name: greenkeeper lockfile upload
          command: |
            cd frontend
            node ./node_modules/.bin/greenkeeper-lockfile-upload
            cd -
      - run:
          name: build images
          command: |
            ./build.sh build yeldir
  build_and_publish:
    <<: *default_machine
    filters:
      branches:
        only: master
    steps:
      - checkout
      - run:
          name: npm install
          command: |
            cd frontend
            npm install
            cd -
      - run:
          name: greenkeeper lockfile update
          command: |
            cd frontend
            node ./node_modules/.bin/greenkeeper-lockfile-update
            cd -
      - run:
          name: test images
          command: |
            ./build.sh test
      - run:
          name: greenkeeper lockfile upload
          command: |
            cd frontend
            node ./node_modules/.bin/greenkeeper-lockfile-upload
            cd -
      - run:
          name: build images
          command: |
            ./build.sh build yeldir
      - run:
          name: login to docker hub
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
      - run:
          name: push images to docker hub
          command: |
            ./build.sh publish yeldir